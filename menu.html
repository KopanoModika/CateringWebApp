<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <header>
        <h1>Our Menu</h1>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="menu.html">Menu</a></li>
                <li><a href="bookings.html">Bookings</a></li>
                <li><a href="login.html">Login</a></li>
                <li><a href="register.html">Register</a></li>
               
                <button onclick="openCart()" class="cart-btn">
                    <i class="fas fa-shopping-cart"></i> View Cart
                </button>
                
            </ul>
                
            </ul>
        </nav>
    </header>
    <br><br>
   
            <h2>Delicious Dishes</h2>
            <br>
            <center><p>Explore our diverse menu filled with delectable dishes.</p></center> 
        

        <div class="menu" id="menu">
            <h1>Menu</h1>

            <div class="menu_box">
                <div class="menu_card">
                    <div class="menu_image">
                         <img src="images/webgallary.jpg">
                    </div>

                   <div class="menu_info">
                    <h2>Platter 1</h2>
                    <p>Meatballs, scones and beef flavoured mini pastries</p>
                   </div>

                   <h3>R80.00</h3>
                   <button class="menu_btn" onclick="addToCart('Platter 1', 80)">Order Now</button>
                </div>

                <div class="menu_card">
                    <div class="menu_image">
                         <img src="images/webgallary(2).jpg">
                    </div>

                   <div class="menu_info">
                    <h2>Platter 2</h2>
                    <p>Meatballs, Beef samoosas, and beef flavoured mini pastries</p>
                   </div>

                   <h3>R90.00</h3>
                   <button class="menu_btn" onclick="addToCart('Platter 2', 90)">Order Now</button>
                </div>

                <div class="menu_card">
                    <div class="menu_image">
                         <img src="images/webgallary (3).jpg">
                    </div>

                   <div class="menu_info">
                    <h2>Burger</h2>
                    <p>Smoked Salmon Avocado Burger</p>
                   </div>

                   <h3>R65.00</h3>
                   <button class="menu_btn" onclick="addToCart('Burger', 65)">Order Now</button>
                </div>

                <div class="menu_card">
                    <div class="menu_image">
                         <img src="images/webgallary (4).jpg">
                    </div>

                   <div class="menu_info">
                    <h2>Platter 3</h2>
                    <p>Cheese and Tomato crossant sandwiches</p>
                   </div>

                   <h3>R88.00</h3>
                   <button class="menu_btn" onclick="addToCart('Platter 3', 88)">Order Now</button>
                </div>

                <div class="menu_card">
                    <div class="menu_image">
                         <img src="images/webgallary (6).jpg">
                    </div>

                   <div class="menu_info">
                    <h2>Platter 4</h2>
                    <p>Chocolate, vanila, cappochino and blueberry muffins</p>
                   </div>

                   <h3>R93.00</h3>
                   <button class="menu_btn" onclick="addToCart('Platter 4', 93)">Order Now</button>
                </div>

                <div class="menu_card">
                    <div class="menu_image">
                         <img src="images/webgallary (7).jpg">
                    </div>

                   <div class="menu_info">
                    <h2>Salad</h2>
                    <p>Margarita Salad</p>
                   </div>

                   <h3>R45.00</h3>
                   <button class="menu_btn" onclick="addToCart('Salad', 45)">Order Now</button>
                </div>

                <div class="menu_card">
                    <div class="menu_image">
                         <img src="images/webgallary (9).jpg">
                    </div>

                   <div class="menu_info">
                    <h2>Platter 5</h2>
                    <p>Roast beef chunks, beef sausage bits and chicken vienna bits</p>
                   </div>

                   <h3>R100.00</h3>
                   <button class="menu_btn" onclick="addToCart('Platter 5', 100)">Order Now</button>
                </div>

            </div>

            <div id="cartPopup" class="popup">
                <div class="popup-content">
                    <h2>Your Cart</h2>
                    <br>
                    <h4>Proceed to place your order</h4>
                    <br>
                    <ul id="cartItems"></ul>
                    <br>
                    <p>Total: R<span id="totalAmount">0</span></p>
                    <button id="checkoutButton" class="btn">Checkout</button>
                    <button onclick="closeCart()" class="btn">Close</button>
                </div>
            </div>
        
            <!-- Firebase SDKs -->
            <script src="https://www.gstatic.com/firebasejs/9.6.6/firebase-app-compat.js"></script>
            <script src="https://www.gstatic.com/firebasejs/9.6.6/firebase-database-compat.js"></script>
            <script src="https://www.gstatic.com/firebasejs/9.6.6/firebase-auth-compat.js"></script>
            <!--<script src="https://www.gstatic.com/firebasejs/9.6.6/firebase-firestore-compat.js"></script>-->
            
        </div>
    
    <br><br>
    <script>
         // Initialize Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDpqm4ffkFpNpzleTRQd3vEUGY7XDTo6_g",
        authDomain: "catering-webapp.firebaseapp.com",
        databaseURL: "https://catering-webapp-default-rtdb.firebaseio.com",
        projectId: "catering-webapp",
        storageBucket: "catering-webapp.appspot.com",
        messagingSenderId: "249720880975",
        appId: "1:249720880975:web:cb520c4f8b9bdb92fc8f3a"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
   // const firestore = firebase.firestore();
    const auth = firebase.auth();

    let cart = {};

    // Check if user is logged in and display username
    auth.onAuthStateChanged(user => {
            const usernameDisplay = document.getElementById("usernameDisplay");
            const loginLink = document.getElementById("loginLink");
            const registerLink = document.getElementById("registerLink");

            if (user) {
                // Hide login and register links
                loginLink.style.display = "none";
                registerLink.style.display = "none";

                // Fetch user's first name from Firestore
                firestore.collection("users").doc(user.uid).get()
                    .then(docSnapshot => {
                        if (docSnapshot.exists) {
                            const firstName = docSnapshot.data().FirstName;
                            usernameDisplay.textContent = `Hello, ${firstName}`;
                        } else {
                            usernameDisplay.textContent = "Hello, User";
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching user data: ", error);
                        usernameDisplay.textContent = "Hello, User";
                    });
            } else {
                // User is not logged in, show login/register links
                loginLink.style.display = "inline";
                registerLink.style.display = "inline";
                usernameDisplay.textContent = "Guest";
            }
        });

        // Add item to cart
        function addToCart(itemName, price) {
            auth.onAuthStateChanged(user => {
                if (user) {
                    if (!cart[itemName]) {
                        cart[itemName] = { quantity: 1, price };
                    } else {
                        cart[itemName].quantity += 1;
                    }
                    updateCartDisplay();
                    updateFirebaseDatabase();
                } else {
                    alert("Please log in to add items to the cart.");
                }
            });
        }

        // Remove item from cart
        function removeFromCart(itemName) {
            if (cart[itemName]) {
                cart[itemName].quantity -= 1;
                if (cart[itemName].quantity <= 0) delete cart[itemName];
            }
            updateCartDisplay();
            updateFirebaseDatabase();
        }

        // Update cart display in popup
        function updateCartDisplay() {
            const cartItems = document.getElementById("cartItems");
            const totalAmount = document.getElementById("totalAmount");
            cartItems.innerHTML = '';
            let total = 0;

            for (let item in cart) {
                const { quantity, price } = cart[item];
                total += quantity * price;
                cartItems.innerHTML += `<li>${item} - R${price} x ${quantity}
                                         <button onclick="removeFromCart('${item}')">remove item</button></li>`;
            }

            totalAmount.textContent = total.toFixed(2);
            document.getElementById("checkoutButton").disabled = total === 0;
        }

        // Save cart data to Firebase Realtime Database
        function updateFirebaseDatabase() {
            const user = auth.currentUser;
            if (user) {
                database.ref("cart/" + user.uid).set(cart);
            }
        }

        // Save order to Firestore upon checkout
        function saveOrderToFirestore(userId) {
            firestore.collection("orders").add({
                userId: userId,
                items: cart,
                orderDate: new Date().toISOString(),
                status: 'Pending'
            }).then(() => {
                console.log("Order saved to Firestore.");
                alert("Order placed successfully!");
                cart = {}; // Clear the cart
                updateCartDisplay();
            }).catch(error => {
                console.error("Error saving order:", error);
            });
        }

        // Checkout function
        function checkout() {
            const user = auth.currentUser;
            if (user) {
                saveOrderToFirestore(user.uid);
                closeCart();
            } else {
                alert("Please log in to proceed with checkout.");
            }
        }

        // Open and close cart popup
        function openCart() {
            document.getElementById("cartPopup").classList.add("show");
        }

        function closeCart() {
            document.getElementById("cartPopup").classList.remove("show");
        }
    </script>

    <style>
       
        footer {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</body>
<footer>
        <p>&copy; 2024 Code Crafters</p>
</footer>
</html>
